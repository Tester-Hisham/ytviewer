<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Liquid Glass YouTube Viewer</title>
<style>
  body {
    margin:0; font-family:sans-serif; background:#0d0d0d; color:white;
    overflow:hidden; display:flex; flex-direction:column; height:100vh;
  }
  #bg {
    position:fixed; top:0; left:0; width:100%; height:100%;
    overflow:hidden; z-index:-1;
  }
  .blob {
    position:absolute; border-radius:50%;
    background:radial-gradient(circle at 30% 30%, rgba(255,0,150,0.6), rgba(0,200,255,0.4));
    mix-blend-mode:screen; filter:blur(60px);
  }
  #topbar {
    padding:8px; background:#111; display:flex; gap:8px; align-items:center;
  }
  #urlInput { flex:1; padding:6px; }
  button { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; }
  #main { flex:1; display:grid; grid-template-columns:2fr 1fr; overflow:hidden; }
  #playerContainer { position:relative; }
  #player, #placeholder { width:100%; height:100%; }
  #placeholder { display:grid; place-items:center; font-size:2em; opacity:0.5; }
  #playlist { overflow-y:auto; background:#181818; padding:10px; }
  .item { padding:6px; border-bottom:1px solid #333; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
  .item.active { background:#333; }
  .toast {
    position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
    background:#222; padding:10px 20px; border-radius:8px; opacity:0;
    transition:opacity 0.5s;
  }
  .toast.show { opacity:1; }
</style>
</head>
<body>

<div id="bg"></div>

<div id="topbar">
  <input id="urlInput" placeholder="Paste YouTube link or ID"/>
  <button onclick="addVideo()">Add</button>
  <button onclick="prev()">Prev</button>
  <button onclick="next()">Next</button>
  <button id="micBtn">Mic React</button>
</div>

<div id="main">
  <div id="playerContainer">
    <div id="player"></div>
    <div id="placeholder">No Video</div>
  </div>
  <div id="playlist"></div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ================== Background Blobs ================== */
const bg=document.getElementById('bg');
const blobs=[];
for(let i=0;i<6;i++){
  const b=document.createElement('div');
  b.className='blob';
  b.style.width=b.style.height=(200+Math.random()*200)+'px';
  b.style.left=Math.random()*100+'%';
  b.style.top=Math.random()*100+'%';
  bg.appendChild(b); blobs.push(b);
}
let analyser=null, dataArray=null;
function animate(){
  requestAnimationFrame(animate);
  blobs.forEach((b,i)=>{
    let scale=1+0.3*Math.sin(Date.now()/1000+i);
    if(analyser && dataArray){
      analyser.getByteFrequencyData(dataArray);
      let avg=dataArray.reduce((a,c)=>a+c,0)/dataArray.length/255;
      scale+=avg*2;
    }
    b.style.transform=`scale(${scale})`;
  });
}
animate();

/* ================== Toast ================== */
function notify(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),1500);
}

/* ================== Playlist ================== */
let state={playlists:{default:[]},currentPlaylist:'default',idx:-1};
let player=null;
function saveState(){ localStorage.setItem('ytState',JSON.stringify(state)); }
function loadState(){ let s=localStorage.getItem('ytState'); if(s) state=JSON.parse(s); renderList(); }
function renderList(){
  const list=state.playlists[state.currentPlaylist]; const el=document.getElementById('playlist');
  el.innerHTML='';
  list.forEach((v,i)=>{
    const row=document.createElement('div');
    row.className='item'+(i===state.idx?' active':'');
    row.innerHTML=`<span>${v.title}</span><button onclick="removeAt(${i});event.stopPropagation()">Ã—</button>`;
    row.onclick=()=>playAt(i); el.appendChild(row);
  });
}
function addVideo(){
  const url=document.getElementById('urlInput').value.trim();
  const id=extractVideoId(url);
  if(!id){ notify("Invalid URL/ID"); return; }
  const title=id;
  state.playlists[state.currentPlaylist].push({id,title});
  document.getElementById('urlInput').value='';
  saveState(); renderList(); notify("Added");
}
function removeAt(i){ state.playlists[state.currentPlaylist].splice(i,1); if(i===state.idx){ state.idx=-1; player.stopVideo(); document.getElementById('placeholder').style.display='grid'; } saveState(); renderList(); }
function next(){ const l=state.playlists[state.currentPlaylist]; if(!l.length) return; playAt((state.idx+1)%l.length); }
function prev(){ const l=state.playlists[state.currentPlaylist]; if(!l.length) return; playAt((state.idx-1+l.length)%l.length); }

function playAt(i){
  const list=state.playlists[state.currentPlaylist]; if(!list[i]) return;
  state.idx=i; renderList(); document.getElementById('placeholder').style.display='none';
  if(!player){ player=new YT.Player('player',{height:'100%',width:'100%',videoId:list[i].id,events:{onReady:e=>{ e.target.playVideo(); initAudioContext(e.target); },onStateChange:e=>{ if(e.data===YT.PlayerState.ENDED) next(); }}}); }
  else { player.loadVideoById(list[i].id); initAudioContext(player); }
  notify("Playing: "+list[i].title); saveState();
}

/* ================== FIXED extractVideoId ================== */
function extractVideoId(url) {
  if (!url) return null;
  const reg=/(?:youtube\.com\/(?:watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
  const m=url.match(reg);
  if (m) return m[1];
  if (url.length===11 && /^[a-zA-Z0-9_-]+$/.test(url)) return url;
  return null;
}

/* ================== YouTube API ================== */
const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.body.appendChild(tag);

/* ================== Audio Context (Video React) ================== */
function initAudioContext(playerInstance){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const source=ctx.createMediaElementSource(playerInstance.getIframe());
    analyser=ctx.createAnalyser(); analyser.fftSize=256;
    dataArray=new Uint8Array(analyser.frequencyBinCount);
    source.connect(analyser); analyser.connect(ctx.destination);
  }catch(e){ console.warn("AudioContext error:",e); }
}

/* ================== Mic Input ================== */
let micEnabled=false;
document.getElementById('micBtn').onclick=async()=>{
  if(!micEnabled){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      const source=audioCtx.createMediaStreamSource(stream);
      analyser=audioCtx.createAnalyser(); analyser.fftSize=256;
      dataArray=new Uint8Array(analyser.frequencyBinCount);
      source.connect(analyser);
      micEnabled=true;
      notify("Mic input enabled");
    }catch{ alert('Mic access denied'); }
  }else{ analyser=null; dataArray=null; micEnabled=false; notify("Mic input disabled"); }
};

loadState();
</script>
</body>
</html>
