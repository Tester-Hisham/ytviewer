<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Liquid Glass YouTube Viewer</title>
<style>
  :root {
    --bg: #0f1115;
    --panel: #161a22;
    --panel-2: #1c2230;
    --text: #f0f0f0;
    --accent: #3fa9f5;
  }
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    overflow: hidden;
  }
  #app {
    display: grid;
    grid-template-columns: 280px 1fr;
    height: 100vh;
    position: relative;
    z-index: 1;
  }
  #sidebar {
    background: var(--panel);
    display: flex;
    flex-direction: column;
    padding: 10px;
    overflow-y: auto;
  }
  #player-area {
    display: flex;
    flex-direction: column;
    background: var(--panel-2);
    position: relative;
  }
  #player {
    flex: 1;
    min-height: 60%;
  }
  #controls {
    padding: 10px;
    display: flex;
    gap: 10px;
    background: rgba(0,0,0,0.3);
  }
  input, button, select {
    background: #222;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    color: var(--text);
  }
  button:hover { background: var(--accent); cursor: pointer; }
  .video-item {
    padding: 6px;
    margin: 4px 0;
    background: #2226;
    border-radius: 6px;
    cursor: pointer;
  }
  .video-item.active {
    background: var(--accent);
  }
</style>
</head>
<body>

<div id="app">
  <div id="sidebar">
    <h3>Playlists</h3>
    <select id="playlistSelect"></select>
    <div style="margin-top:10px;">
      <input id="videoUrl" type="text" placeholder="Paste YouTube URL or ID" style="width:100%;margin-bottom:5px;">
      <button onclick="addVideo()">Add Video</button>
      <button onclick="removeSelected()">Remove</button>
      <button onclick="next()">Next ▶</button>
      <button onclick="prev()">◀ Prev</button>
      <button onclick="shuffleList()">Shuffle</button>
      <button onclick="clearList()">Clear</button>
    </div>
    <h4 style="margin-top:10px;">Videos</h4>
    <div id="videoList"></div>
  </div>
  <div id="player-area">
    <div id="player"></div>
    <div id="controls">
      <button onclick="prev()">◀ Prev</button>
      <button onclick="next()">Next ▶</button>
    </div>
  </div>
</div>

<!-- Background blobs -->
<canvas id="bg-blobs"></canvas>

<script>
// ============ STATE ============
let state = { playlists:{Default:[]}, current:"Default", idx:-1 };
let player;

// Load from localStorage
function loadState(){
  const saved = localStorage.getItem("ytviewer");
  if(saved) state = JSON.parse(saved);
  renderPlaylists();
  renderList();
}
function saveState(){ localStorage.setItem("ytviewer", JSON.stringify(state)); }

// ============ UI ============
function renderPlaylists(){
  const sel=document.getElementById("playlistSelect");
  sel.innerHTML="";
  for(const name in state.playlists){
    const opt=document.createElement("option");
    opt.value=name; opt.textContent=name;
    if(name===state.current) opt.selected=true;
    sel.appendChild(opt);
  }
  sel.onchange=()=>{ state.current=sel.value; state.idx=-1; renderList(); saveState(); };
}
function renderList(){
  const list=state.playlists[state.current];
  const container=document.getElementById("videoList");
  container.innerHTML="";
  list.forEach((v,i)=>{
    const div=document.createElement("div");
    div.className="video-item"+(i===state.idx?" active":"");
    div.textContent=v.title||v.id;
    div.onclick=()=>playAt(i);
    container.appendChild(div);
  });
}

// ============ Playlist actions ============
function addVideo(){
  const input=document.getElementById("videoUrl");
  const id=extractVideoId(input.value.trim());
  if(!id) return alert("Invalid YouTube URL or ID");
  state.playlists[state.current].push({id,title:id});
  input.value="";
  saveState(); renderList();
}
function removeSelected(){
  if(state.idx<0) return;
  state.playlists[state.current].splice(state.idx,1);
  state.idx=-1; saveState(); renderList();
}
function clearList(){ state.playlists[state.current]=[]; state.idx=-1; saveState(); renderList(); }
function shuffleList(){ shuffle(state.playlists[state.current]); saveState(); renderList(); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

function extractVideoId(url){
  const m=url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
  return m?m[1]:(url.length===11?url:null);
}

// ============ Player ============
function playAt(i){
  const list=state.playlists[state.current]; if(!list[i]) return;
  state.idx=i; renderList();
  if(!player) initPlayer(list[i].id);
  else player.loadVideoById(list[i].id);
  saveState();
}
function next(){ const list=state.playlists[state.current]; if(list.length===0) return; state.idx=(state.idx+1)%list.length; playAt(state.idx); }
function prev(){ const list=state.playlists[state.current]; if(list.length===0) return; state.idx=(state.idx-1+list.length)%list.length; playAt(state.idx); }

function initPlayer(id){
  const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.body.appendChild(tag);
  window.onYouTubeIframeAPIReady=function(){
    player=new YT.Player('player',{
      height:'100%', width:'100%', videoId:id,
      playerVars:{controls:1,rel:0},
      events:{onStateChange:onPlayerState}
    });
  }
}
function onPlayerState(e){ if(e.data===YT.PlayerState.ENDED) next(); }

// Keyboard
document.addEventListener("keydown",e=>{
  if(e.code==="ArrowRight") next();
  if(e.code==="ArrowLeft") prev();
});

// ============ Background Blobs ============
const canvas=document.getElementById("bg-blobs");
const ctx=canvas.getContext("2d");
function resize(){ canvas.width=innerWidth; canvas.height=innerHeight; }
resize(); addEventListener("resize",resize);

let audioCtx, analyser, dataArray;
function initAudioAnalyser(){
  if(audioCtx) return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=128; // more sensitive
  dataArray=new Uint8Array(analyser.frequencyBinCount);

  // try hooking iframe audio (will only work if CORS allows)
  const video=document.querySelector("iframe");
  if(video){
    try{
      const src=audioCtx.createMediaElementSource(video);
      src.connect(analyser);
      analyser.connect(audioCtx.destination);
    }catch(e){ console.warn("Audio analyser not allowed:",e); }
  }
}
document.body.addEventListener("click",initAudioAnalyser,{once:true});

function draw(){
  requestAnimationFrame(draw);
  if(!analyser) return;

  analyser.getByteFrequencyData(dataArray);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const cx=canvas.width/2, cy=canvas.height/2;
  for(let i=0;i<5;i++){
    let freq=dataArray[i*5]||0;
    let radius=150+freq*3.5; // sensitivity boost
    let hue=(i*70+freq)%360;
    ctx.beginPath();
    ctx.arc(cx+Math.sin(Date.now()/1500+i)*120, cy+Math.cos(Date.now()/1500+i)*120, radius, 0, Math.PI*2);
    ctx.fillStyle=`hsla(${hue},90%,55%,0.25)`;
    ctx.fill();
  }
}
draw();

// ============ Init ============
loadState();
</script>
</body>
</html>
